---
title: "Explore response data"
output: 
  html_notebook:
    toc: yes
    toc_depth: 2
    toc_float: true
    theme: cerulean
---

```{r echo=FALSE, warning=FALSE, message=F}
suppressMessages(library(tidyverse))
suppressMessages(library(xtable))
suppressMessages(library(pheatmap))
suppressMessages(library(RColorBrewer))
suppressMessages(library(ggpubr))
```


```{r echo=F,warning=FALSE, message=FALSE}
load("../data/df.all.RData")
df <- df.all
```

Scale data by dataset mean and standard deviation

```{r echo=F,warning=FALSE, message=FALSE}
ggplot(df,aes(x=sample,y=scaled_value)) + geom_boxplot(outlier.shape=NA) + theme_classic()
```


```{r echo=F,warning=FALSE, message=FALSE}
plot_gene <- function(d,gene_of_interest){
  d %>% filter(Gene==gene_of_interest) %>% select(scaled_value,dataset,objective_response) %>%
  .[complete.cases(.),] %>%
  ggplot(aes(x=dataset,y=scaled_value,fill=objective_response)) +   geom_boxplot(outlier.shape = NA) + ggtitle(gene_of_interest) +
  geom_point(position=position_jitterdodge(0.1),shape=16,size=1) +
  theme_classic()
}
```


```{r echo=F,warning=FALSE, message=FALSE}
plot_gene(df,"CTLA4")
plot_gene(df,"PDCD1")
plot_gene(df,"CD274")
```


```{r echo=F,warning=FALSE, message=FALSE} 
## Uses ggpubr to add pairwise p-values
plot_gene_stats <- function (d,gene_of_interest){
  d %>% filter(Gene==gene_of_interest) %>% select(scaled_value,dataset,objective_response) %>% .[complete.cases(.),] %>% 
ggboxplot(x = "dataset", y = "scaled_value",color="objective_response",add = "jitter") + 
    stat_compare_means(aes(group =objective_response),label = "p.format",method = "t.test") +
    ggtitle(gene_of_interest)
}
## Hmm, some package versions (?) do not correctly do the two-factor jitter
## See http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/76-add-p-values-and-significance-levels-to-ggplots/
## This should work
## ggboxplot(ToothGrowth, x = "dose", y = "len", color = "supp", palette = "jco",add = "jitter")
```


```{r echo=F,warning=FALSE, message=FALSE}
plot_gene_stats(df,"CTLA4")
plot_gene_stats(df,"PDCD1")
plot_gene_stats(df,"CD274")
```

## Test gene list for differences in response

### Longer list 

```{r echo=F,warning=FALSE, message=FALSE}
gois <- read_tsv(file="../data/curated_gene_list.txt")[[1]]
## 551 of 715 gois have match IMPRES gene symbols
```
Of `r length(gois)` genes of interest, `r length(intersect(gois,unique(df$Gene)))` are represented by gene symbol in the IMPRES set.

For each of those, compute ANOVA for linear model, with dataset and objective_response as effects.

```{r echo=F,warning=FALSE, message=FALSE}
d <- df %>% filter(Gene %in% gois) %>% select(Gene,scaled_value,dataset,objective_response) %>% .[complete.cases(.),] 

dd <- d %>% split(.$Gene) %>%
            map( ~ lm(scaled_value ~ dataset + objective_response, data=.)) %>%
            map(anova) %>%
            map(~. ["objective_response","Pr(>F)"]) %>%
            unlist()

```

Lowest 10 p-values

```{r results='asis', echo=FALSE}
a <- as.matrix(head(sort(dd,decreasing =F),10));  colnames(a)  <- "P-value"
print(xtable(a,digits=5),type='html')
```


Plots for top three


```{r echo=F,warning=FALSE, message=FALSE}
plot_gene_stats(df,"CCR7")
plot_gene_stats(df,"CYFIP2")
plot_gene_stats(df,"CXCL13")
```
### More focused list

```{r echo=F,warning=FALSE, message=FALSE}
gois <- read_tsv(file="../data/focused_gene_list.txt")[[1]]
```
Of `r length(gois)` genes of interest, `r length(intersect(gois,unique(df$Gene)))` are represented by gene symbol in the IMPRES set.

For each of those, compute ANOVA for linear model, with dataset and objective_response as effects.

```{r echo=F,warning=FALSE, message=FALSE}
d <- df %>% filter(Gene %in% gois) %>% select(Gene,scaled_value,dataset,objective_response) %>% .[complete.cases(.),] 

dd <- d %>% split(.$Gene) %>%
            map( ~ lm(scaled_value ~ dataset + objective_response, data=.)) %>%
            map(anova) %>%
            map(~. ["objective_response","Pr(>F)"]) %>%
            unlist()

```

Lowest 10 p-values

```{r results='asis', echo=FALSE}
a <- as.matrix(head(sort(dd,decreasing =F),10));  colnames(a)  <- "P-value"
print(xtable(a,digits=5),type='html')
```


Plots for top three


```{r echo=F,warning=FALSE, message=FALSE}
plot_gene_stats(df,"PDCD1")
plot_gene_stats(df,"CXCR3")
plot_gene_stats(df,"TIGIT")
```
